name: GPUaaS Test Suite

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 0 * * 0'

env:
  PYTHON_VERSION: '3.9'
  BASE_URL: 'http://localhost:8000'
  TEST_USER: 'test_user'
  TEST_PASSWORD: 'test_pass'

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.9', '3.10', '3.11']

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y python3-pip python3-venv

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        playwright install chromium
        playwright install-deps

    - name: Start Mock GPUaaS Server
      run: |
        echo "Starting mock server..."
        python mock_gpuas_simulator.py &
        SERVER_PID=$!
        echo $SERVER_PID > server.pid
        sleep 10

        curl -f http://localhost:8000/health || exit 1
        echo "Mock server started successfully"

    - name: Run API tests
      run: |
        echo "Running API tests..."
        pytest tests/api/ -v \
          --html=reports/api-report.html \
          --junitxml=reports/api-results.xml \
          --cov=core \
          --cov-report=html:reports/coverage-api \
          --cov-report=xml:reports/coverage-api.xml

    - name: Run UI tests
      run: |
        echo "Running UI tests..."
        pytest tests/ui/ -v \
          --html=reports/ui-report.html \
          --junitxml=reports/ui-results.xml

    - name: Run performance tests
      run: |
        echo "Running performance tests..."
        locust -f tests/performance/test_load.py \
          --host=http://localhost:8000 \
          --users=5 \
          --spawn-rate=1 \
          --run-time=30s \
          --headless \
          --csv=reports/performance \
          --html=reports/performance-report.html &
        LOCUST_PID=$!
        wait $LOCUST_PID

    - name: Stop Mock Server
      if: always()
      run: |
        if [ -f server.pid ]; then
          kill $(cat server.pid) 2>/dev/null || true
          echo "Mock server stopped"
        fi

    - name: Upload test reports
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: test-reports-${{ matrix.python-version }}
        path: |
          reports/
          .pytest_cache/
        retention-days: 7

    - name: Upload coverage to Codecov
      if: success()
      uses: codecov/codecov-action@v3
      with:
        file: reports/coverage-api.xml
        flags: unittests
        name: codecov-umbrella

    - name: Generate test summary
      if: always()
      run: |
        echo "### Test Results Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Python Version:** ${{ matrix.python-version }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [ -f reports/api-results.xml ]; then
          API_TESTS=$(grep -o 'tests="[0-9]*"' reports/api-results.xml | head -1 | grep -o '[0-9]*')
          API_FAILURES=$(grep -o 'failures="[0-9]*"' reports/api-results.xml | head -1 | grep -o '[0-9]*')
          API_ERRORS=$(grep -o 'errors="[0-9]*"' reports/api-results.xml | head -1 | grep -o '[0-9]*')

          echo "**API Tests:**" >> $GITHUB_STEP_SUMMARY
          echo "- Total: $API_TESTS" >> $GITHUB_STEP_SUMMARY
          echo "- Failures: $API_FAILURES" >> $GITHUB_STEP_SUMMARY
          echo "- Errors: $API_ERRORS" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
        fi

        if [ -f reports/ui-results.xml ]; then
          UI_TESTS=$(grep -o 'tests="[0-9]*"' reports/ui-results.xml | head -1 | grep -o '[0-9]*')
          UI_FAILURES=$(grep -o 'failures="[0-9]*"' reports/ui-results.xml | head -1 | grep -o '[0-9]*')

          echo "**UI Tests:**" >> $GITHUB_STEP_SUMMARY
          echo "- Total: $UI_TESTS" >> $GITHUB_STEP_SUMMARY
          echo "- Failures: $UI_FAILURES" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
        fi

  security-scan:
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Run security scan
      uses: snyk/actions/python@master
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      with:
        args: --severity-threshold=high

    - name: Dependency check
      run: |
        pip install safety
        safety check --full-report

  deploy-demo:
    runs-on: ubuntu-latest
    needs: [test, security-scan]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Deploy to Railway/Render
      run: |
        echo "Demo deployment would happen here"
